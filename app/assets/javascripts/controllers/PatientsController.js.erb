app.controller('PatientsController', ['$scope', '$http', '$upload', '$state', '$stateParams', 'AuthInterceptor', 'LocalService', 'flare', function($scope, $http, $upload, $state, $stateParams, AuthInterceptor, LocalService, flare) {
  $scope.patient = {};
  $scope.avatar = [];
  $scope.patient.id = $stateParams.patientId  ;
  var req = {
    method: 'GET',
    url: '/patients/' + $scope.patient.id + '.json',
    headers: $http.defaults.headers.common
  };
  req = AuthInterceptor.request(req);
  $http(req)
    .success(function(data) {
      $scope.patient = data.patient;
    }).error(function(err) {
      console.log(err);
    });

  $scope.updatePatient = function() {
    var req = {
      method: 'PATCH',
      url: '/patients/' + $scope.patient.id,
      headers: $http.defaults.headers.patch,
      fields: $scope.patient,
      formDataAppender: function(fd, key, val) {
        fd.append('patient['+key+']', val);
      },
      file: $scope.avatar,
      fileFormDataName: 'patient[avatar]'
    };
    req = AuthInterceptor.request(req);
    $upload.upload(req)
        .success(function(data) {
          flare.success(data.status, 10000);
          $state.go('user.home');
        }).error(function(err) {
          flare.error(err.errors, 10000);
        });
  };


}]);