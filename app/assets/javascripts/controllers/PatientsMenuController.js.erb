angular.module('mdme').controller('PatientsMenuController', ['$scope', '$state', '$timeout', '$http', 'Auth', 'AuthInterceptor', function($scope, $state, $timeout, $http, Auth, AuthInterceptor) {
  $scope.logoSrc = '<%= asset_path("full_logo_white.png") %>';
  $scope.upcommingAppointment = {};
  $scope.showProgressBar = false;
  $scope.color = '';
  $scope.barClass = 'progress-bar-';
  $scope.percent = 0;
  $scope.date = '';
  $scope.time = '';
  $scope.timeLeft = '';
  $scope.minutesLeft = 0;

  $scope.logout = function() {
    Auth.logout();
    $state.go('anon.home');
  };

  var req = {
    method: 'GET',
    url: '/patients/get-upcoming-appointment.json',
    headers: $http.defaults.headers.common
  };
  req = AuthInterceptor.request(req);
  $http(req)
    .success(function(data) {
        if (data && data.date != null) {
          $scope.showProgressBar = true;
          $scope.color = data.color;
          $scope.barClass += $scope.color;
          $scope.percent = data.percent;
          $scope.date = data.date;
          $scope.time = data.time;
          $scope.minutesLeft = parseInt(data.minutes_left);
          $scope.timeLeft = $scope.minutesLeft + 'minutes until appointment';
          setupCountDown();
        }
  }).error(function(error) {
     console.log(error);
  });
  var stopped;
  var setupCountDown = function() {
    stopped = $timeout(function() {
      $scope.minutesLeft--;
      if ($scope.minutesLeft > 0) {
        if ($scope.minutesLeft > 20 ) {
          $scope.color = 'success';
          if ($scope.minutesLeft >= 80) {
            $scope.percent = 20;
          }
          else if($scope.minutesLeft >= 70) {
            $scope.percent = 40;
          }
          else if ($scope.minutesLeft >= 60) {
            $scope.percent = 50;
          }
          else if ($scope.minutesLeft >= 35) {
            $scope.percent = 65;
          }
          else {
            $scope.percent = 75;
          }
        }
        else if ($scope.minutesLeft > 5 && $scope.minutesLeft < 20) {
          $scope.color = 'warning';
          $scope.percent = 80;
        }
        else {
          $scope.color = 'danger';
          $scope.percent = 90;
        }
        $scope.timeLeft = $scope.minutesLeft + 'minutes until appointment';
        setupCountDown();
      }
    }, 60000);
  }
}]);