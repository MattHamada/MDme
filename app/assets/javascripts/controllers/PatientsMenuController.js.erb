angular.module('mdme').controller('PatientsMenuController', ['$scope', '$state', '$timeout', '$http', 'Auth', 'AuthInterceptor', 'LocalService', function($scope, $state, $timeout, $http, Auth, AuthInterceptor, LocalService) {
  $scope.logoSrc = '<%= asset_path("full_logo_white.png") %>';
  $scope.upcommingAppointment = {};
  $scope.progressBar = {};
  $scope.showProgressBar = false;
  $scope.patient = {id: LocalService.get('userId') };

  $scope.logout = function() {
    Auth.logout();
    $state.go('anon.home');
  };

  var req = {
    method: 'GET',
    url: '/patients/get-upcoming-appointment.json',
    headers: $http.defaults.headers.common
  };
  req = AuthInterceptor.request(req);
  $http(req)
    .success(function(data) {
        if (data && data.date != null) {
          $scope.showProgressBar = true;
          $scope.progressBar = data;
//          $scope.color = data.color;
//          $scope.barClass = $scope.color;
//          $scope.percent = data.percent;
//          $scope.date = data.date;
//          $scope.time = data.time;
//          $scope.minutesLeft = parseInt(data.minutesLeft);
//          $scope.timeLeft = $scope.minutesLeft + 'minutes until appointment';
          setupCountDown();
        }
  }).error(function(error) {
     console.log(error);
  });

  $scope.getPercentStyle = function() {
    return {
      'width': $scope.progressBar.percent + '%'
    }
  };
  var stopped;
  var setupCountDown = function() {
    stopped = $timeout(function() {
      $scope.progressBar.minutesLeft--;
      if ($scope.progressBar.minutesLeft > 0) {
        $scope.progressBar.percent = (100-$scope.progressBar.minutesLeft).toString();
        if ($scope.progressBar.minutesLeft > 20 ) {
          $scope.progressBar.color = 'success';
//          if ($scope.progressBar.minutesLeft >= 80) {
//            $scope.progressBar.percent = ;
//          }
//          else if($scope.progressBar.minutesLeft >= 70) {
//            $scope.progressBar.percent = '40';
//          }
//          else if ($scope.progressBar.minutesLeft >= 60) {
//            $scope.progressBar.percent = '50';
//          }
//          else if ($scope.progressBar.minutesLeft >= 35) {
//            $scope.progressBar.percent = '65';
//          }
//          else {
//            $scope.progressBar.percent = '75';
//          }
        }
        else if ($scope.progressBar.minutesLeft > 5 && $scope.progressBar.minutesLeft <= 20) {
          $scope.progressBar.color = 'warning';
          $scope.progressBar.barClass = 'progress-bar-warning';
//          $scope.progressBar.percent = '80';
        }
        else {
          $scope.progressBar.color = 'danger';
          $scope.progressBar.barClass = 'progress-bar-danger';
//          $scope.progressBar.percent = '90';
        }
        $scope.progressBar.timeLeft = $scope.progressBar.minutesLeft + 'minutes until appointment';
        setupCountDown();
      }
    }, 60000);
  }
}]);